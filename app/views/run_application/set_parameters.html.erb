<h1>Project <%= session[:project] %></h1>
<hr />
<%= params %>
<h2>Set Parameters <span style="color:gray;font-size:medium"><%= @sushi_app.class %></span></h2>
<blockquote>
  <%= @sushi_app.description.to_s.html_safe %>
</blockquote>
<hr />
<%= form_tag(:action => 'confirmation') do %>
  <%= hidden_field :sushi_app, :class, :value => @sushi_app.class %>
  <%= hidden_field :data_set, :id, :value => @data_set.id %>
  <h3>Next DataSet</h3>
    <table>
      <tr>
        <th>Name</th>
        <td><%= text_field :next_dataset, :name, :value => [@sushi_app.analysis_category, @sushi_app.name, @data_set.id].join('_').gsub(/\s/,'') %></td>
      </tr>
      <tr>
        <th>Comment</th>
        <td><%= text_field :next_dataset, :comment, :value => "" %></td>
      </tr>
    </table>
  <h3>Parameters</h3>
    <table>
      <% @sushi_app.params.each do |key, value| %>
        <tr>
          <th><%= key %></th>
          <td>
          <% case key %>
          <% when 'ram' %>
            <%= text_field :parameters, key.to_sym, :value => "#{value}" %> GB
          <% when 'scratch' %>
            <%= text_field :parameters, key.to_sym, :value => "#{value}" %> GB
          <% when 'process_mode' %>
            <% if value.kind_of?(Array)%>
              <%= select :parameters, key.to_sym, value %>
            <% else %>
              <%= text_field :parameters, key.to_sym, :value => value, :disabled => true %>
            <% end %>
          <% when 'node' %>
            <%= select_tag "parameters[#{key}]", options_for_select(@nodes), :multiple => true, :size => 10 %><br />
            (Grid Engine Status: <%= link_to 'http://fgcz-s-021.uzh.ch/cgi-bin/fgcz_ge_info.py', 'http://fgcz-s-021.uzh.ch/cgi-bin/fgcz_ge_info.py' %>)
          <% when 'grouping' %>
						<%= select :parameters, :grouping, options_for_select(@factor_colums.keys.map{|factor| [factor.split.first, factor.split.first]}, params[:grouping]),  :prompt => "select please" %>
          <% when 'sampleGroup' %>
						<%= render :partial => '/run_application/select_factor' %>
          <% when 'refGroup' %>
						<%= render :partial => '/run_application/select_ref_group' %>
          <% else %>
            <% if value.instance_of?(TrueClass) or value.instance_of?(FalseClass) %>
              <%= select :parameters, key.to_sym, ['true', 'false'], :selected => value.to_s %>
            <% elsif value.instance_of?(Array) %>
              <%= select :parameters, key.to_sym, value, :selected => value.first %>
            <% elsif value.instance_of?(Hash) %>
              <%= select :parameters, key.to_sym, value, :selected => '' %>
            <% else %>
              <%= text_field :parameters, key.to_sym, :value => "#{value}" %>
            <% end %>
          <% end %>

          <% if @sushi_app.required_params and @sushi_app.required_params.include?(key) %>
            <font color=red>required</font>
          <% end %>
          <span style='color:gray;'><%= @sushi_app.params[key, 'description'].to_s %></span>
        </td>
        </tr>
      <% end %>
			<tr>
				<th>Prefecture</th>
				<td>
					<%= select :parameters, :pref_id, options_for_select(@prefectures.map{|obj| [obj.name, obj.id]}, params['pref_id']),  :prompt => "select please" %>
				</td>
			</tr><tr>
				<th>City</th>
				<td>
					<%= render :partial => '/run_application/select_city' %>
				</td>
			</tr>
    </table>
  <br />
  <br />
  <%= submit_tag 'Next' %>
<% end %>

<script type="text/javascript">
   $(function(){
       $('#parameters_grouping').change(function(){
           var group_name = $("#parameters_grouping").val();
					 var data_set_id = $("#data_set_id").val();
					 //alert(group_name);
					 //alert(data_set_id);
           $.get("/run_application/factor_select?grouping=" + group_name + "&data_set_id=" + data_set_id);
       })
   });
   $(function(){
       $('#parameters_pref_id').change(function(){
           var pref_id = $("#parameters_pref_id").val();
 					//alert(pref_id);
           $.get("/run_application/city_select?pref_id=" + pref_id);
       })
   });
</script>



